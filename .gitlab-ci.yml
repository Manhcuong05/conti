image: 
  name: oven/bun:latest
  entrypoint: [""]

stages:
  - build
  - deploy

variables:
  CI: "true"
  BUN_INSTALL_CACHE_DIR: ~/.bun/install/cache

cache:
  key:
    files:
      - bun.lock
  paths:
    - ~/.bun/install/cache

default:
  before_script:
    - bun --version

# =======================
# BUILD
# =======================
build:
  stage: build
  rules:
    - changes:
        - src/**
        - public/**
        - scripts/**
        - vite.config.*
        - tsconfig*.json
        - package.json
        - bun.lock
  script:
    - echo "ğŸ“¦ Install dependencies"
    - bun install --frozen-lockfile

    - echo "âš¡ Build frontend & worker in parallel"
    - bun run build:frontend &
    - bun run build:worker &
    - wait

    - echo "ğŸ§© Fix worker imports"
    - bun run fix:worker-import

  artifacts:
    when: always
    expire_in: 1 day
    paths:
      - dist/

# =======================
# DEPLOY (Prod & Preview)
# =======================
deploy:
  stage: deploy
  needs:
    - job: build
      artifacts: true
  rules:
    # TrÆ°á»ng há»£p 1: Main hoáº·c Master -> Deploy Production
    - if: '$CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "master"'
    # TrÆ°á»ng há»£p 2: CÃ¡c branch khÃ¡c -> Deploy Preview
    - if: '$CI_COMMIT_BRANCH'
  
  script:
    - echo "ğŸš€ Deploying to Cloudflare Pages (Branch $CI_COMMIT_BRANCH)..."

    - echo "ğŸ”§ Install wrangler"
    - bun add -g wrangler
    - |
      echo "â˜ï¸ Deploying..."
      # Wrangler tá»± Ä‘á»™ng xá»­ lÃ½ Prod/Preview dá»±a vÃ o tÃªn branch
      wrangler pages deploy dist \
        --project-name "$CF_PAGES_PROJECT_NAME" \
        --branch "$CI_COMMIT_BRANCH" \
        --commit-hash "$CI_COMMIT_SHA" \
        --commit-message "$CI_COMMIT_MESSAGE"

