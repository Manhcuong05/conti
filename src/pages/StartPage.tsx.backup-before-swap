import React, { useState, useEffect } from 'react';
import { Header } from "@/components/layout/Header";
import { Footer } from "@/components/layout/Footer";
import { Button } from "@/components/ui/button";
import { Card } from "@/components/ui/card";
import { Progress } from "@/components/ui/progress";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Badge } from "@/components/ui/badge";
import { Checkbox } from "@/components/ui/checkbox";
import { Textarea } from "@/components/ui/textarea";
import { RadioGroup, RadioGroupItem } from "@/components/ui/radio-group";
import {
    Rocket,
    ShieldCheck,
    ArrowRight,
    ArrowLeft,
    Building2,
    Check,
    FileText,
    User,
    Loader2,
    CheckCircle2,
    AlertCircle,
    MapPin,
    Mail,
    Phone,
    Globe,
    Printer,
    Calendar,
    DollarSign,
    Users,
    UserPlus,
    X,
    Upload,
    Star,
    CreditCard
} from "lucide-react";
import { motion, AnimatePresence } from "framer-motion";
import { useNavigate, Link, useLocation } from "react-router-dom";
import { api } from "@/lib/api-client";
import { toast } from "sonner";
import { Toaster } from "@/components/ui/sonner";
import { CompanyRegistrySearch } from "@/components/CompanyRegistrySearch";
import { cn } from "@/lib/utils";
import { formatCurrency } from "@/lib/formatting";
import { VIETNAM_PROVINCES } from "@shared/constants";

type OnboardingStep = 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9 | 10 | 'success';
type BusinessType = 'tnhh1' | 'tnhh2' | 'co-phan';
type VATMethod = 'khau-tru' | 'truc-tiep-gtgt' | 'truc-tiep-doanh-so' | 'khong-nop';
type AssetContribution = 'cash' | 'bank-transfer';

interface Founder {
    id: string;
    name: string;
    idNumber: string;
    permanentAddress: string;
    contactAddress: string;
    capitalContribution: number;
    ownershipPercentage: number;
}

const BUSINESS_TYPES = [
    {
        id: 'tnhh1' as BusinessType,
        name: 'C√¥ng ty TNHH 1 Th√†nh vi√™n',
        description: 'Limited Liability Company - Single Member',
        minMembers: 1,
        maxMembers: 1,
        recommended: true,
        benefits: [
            '‚úì 100% quy·ªÅn s·ªü h·ªØu v√† ki·ªÉm so√°t',
            '‚úì Quy tr√¨nh th√†nh l·∫≠p ƒë∆°n gi·∫£n',
            '‚úì Linh ho·∫°t trong qu·∫£n l√Ω v√† ƒëi·ªÅu h√†nh'
        ],
        limitations: [
            '‚úó V·ªën ƒëi·ªÅu l·ªá t·ªëi thi·ªÉu 10 tri·ªáu VNƒê',
            '‚úó M·ªôt ng∆∞·ªùi ch·ªãu tr√°ch nhi·ªám duy nh·∫•t'
        ]
    },
    {
        id: 'tnhh2' as BusinessType,
        name: 'C√¥ng ty TNHH 2 Th√†nh vi√™n tr·ªü l√™n',
        description: 'Limited Liability Company - Multiple Members',
        minMembers: 2,
        maxMembers: 50,
        benefits: [
            '‚úì Ph√¢n chia r·ªßi ro gi·ªØa c√°c th√†nh vi√™n',
            '‚úì D·ªÖ d√†ng huy ƒë·ªông v·ªën',
            '‚úì Linh ho·∫°t trong qu·∫£n tr·ªã'
        ],
        limitations: [
            '‚úó C·∫ßn th·ªèa thu·∫≠n gi·ªØa c√°c th√†nh vi√™n',
            '‚úó C√≥ th·ªÉ xung ƒë·ªôt l·ª£i √≠ch'
        ]
    },
    {
        id: 'co-phan' as BusinessType,
        name: 'C√¥ng ty C·ªï ph·∫ßn',
        description: 'Joint Stock Company',
        minMembers: 3,
        maxMembers: Infinity,
        benefits: [
            '‚úì Huy ƒë·ªông v·ªën qua ph√°t h√†nh c·ªï phi·∫øu',
            '‚úì D·ªÖ d√†ng chuy·ªÉn nh∆∞·ª£ng v·ªën',
            '‚úì Uy t√≠n cao v·ªõi ƒë·ªëi t√°c'
        ],
        limitations: [
            '‚úó Quy tr√¨nh th√†nh l·∫≠p ph·ª©c t·∫°p h∆°n',
            '‚úó Y√™u c·∫ßu c√¥ng b·ªë th√¥ng tin ƒë·ªãnh k·ª≥'
        ]
    },
];

const PACKAGE_OPTIONS = [
    {
        id: 'co-ban',
        name: 'G√≥i C∆° b·∫£n',
        price: 4200000,
        desc: 'Ph√π h·ª£p kh·ªüi ƒë·∫ßu tinh g·ªçn',
        features: ['Gi·∫•y ph√©p kinh doanh', 'Con d·∫•u ph√°p nh√¢n', 'B√°o c√°o th√†nh l·∫≠p']
    },
    {
        id: 'cao-cap',
        name: 'G√≥i Cao c·∫•p',
        price: 5000000,
        desc: 'ƒê·∫ßy ƒë·ªß th·ªß t·ª•c ph√°p l√Ω & thu·∫ø',
        isPopular: true,
        features: ['To√†n b·ªô g√≥i C∆° b·∫£n', 'Khai thu·∫ø m√¥n b√†i', 'Ch·ªØ k√Ω s·ªë 12 th√°ng']
    },
    {
        id: 'kim-cuong',
        name: 'G√≥i Kim c∆∞∆°ng',
        price: 6000000,
        desc: 'Gi·∫£i ph√°p k·∫ø to√°n tr·ªçn g√≥i 1 nƒÉm',
        features: ['To√†n b·ªô g√≥i Cao c·∫•p', 'H√≥a ƒë∆°n ƒëi·ªán t·ª≠', 'K·∫ø to√°n tr·ªçn g√≥i 3 th√°ng']
    },
];

export default function StartPage() {
    const location = useLocation();
    const navigate = useNavigate();
    const [currentStep, setCurrentStep] = useState<OnboardingStep>(1);

    // Step 1: Business Type
    const [businessType, setBusinessType] = useState<BusinessType | null>(null);

    // Step 2: Company Naming
    const [companyNameVi, setCompanyNameVi] = useState("");
    const [companyNameEn, setCompanyNameEn] = useState("");
    const [abbreviation, setAbbreviation] = useState("");
    const [isCheckingName, setIsCheckingName] = useState(false);
    const [nameAvailable, setNameAvailable] = useState<boolean | null>(null);

    // Step 3: Contact & Headquarters
    const [address, setAddress] = useState("");
    const [phone3, setPhone3] = useState("");
    const [email3, setEmail3] = useState("");
    const [website, setWebsite] = useState("");
    const [fax, setFax] = useState("");
    const [addressWarning, setAddressWarning] = useState(false);

    // Step 4: Business Details
    const [businessLines, setBusinessLines] = useState("");
    const [vatMethod, setVATMethod] = useState<VATMethod>('khau-tru');

    // Step 5: Capital & Personnel
    const [charterCapital, setCharterCapital] = useState("");
    const [assetContribution, setAssetContribution] = useState<AssetContribution>('cash');
    const [capitalCompletionDate, setCapitalCompletionDate] = useState("");
    const [legalRepMode, setLegalRepMode] = useState<'vneid' | 'manual'>('manual');
    const [legalRepName, setLegalRepName] = useState("");
    const [legalRepTitle, setLegalRepTitle] = useState("Gi√°m ƒë·ªëc");
    const [legalRepDOB, setLegalRepDOB] = useState("");
    const [legalRepEthnicity, setLegalRepEthnicity] = useState("");
    const [legalRepIDNumber, setLegalRepIDNumber] = useState("");
    const [legalRepIDDate, setLegalRepIDDate] = useState("");
    const [legalRepIDPlace, setLegalRepIDPlace] = useState("");
    const [legalRepPermanentAddress, setLegalRepPermanentAddress] = useState("");
    const [legalRepContactAddress, setLegalRepContactAddress] = useState("");
    const [hasChiefAccountant, setHasChiefAccountant] = useState(false);
    const [caName, setCAName] = useState("");
    const [caDOB, setCADOB] = useState("");
    const [caIDNumber, setCAIDNumber] = useState("");
    const [caIDDate, setCAIDDate] = useState("");
    const [caIDPlace, setCAIDPlace] = useState("");
    const [caAddress, setCAAddress] = useState("");

    // Step 6: Founders
    const [founders, setFounders] = useState<Founder[]>([]);

    // Step 7: Package selection
    const [selectedPackageId, setSelectedPackageId] = useState(() =>
        location.state?.packageId || PACKAGE_OPTIONS[1].id
    );

    // Step 8: Agreement
    const [isAgreed, setIsAgreed] = useState(false);
    const [isSubmitting, setIsSubmitting] = useState(false);

    // NEW: Step 1 - Province Selection
    const [selectedProvince, setSelectedProvince] = useState<string>("");

    // NEW: Step 4 - Company Contact Info (separate from HQ address)
    const [companyPhone, setCompanyPhone] = useState("");
    const [companyEmail, setCompanyEmail] = useState("");
    const [companyWebsite, setCompanyWebsite] = useState("");
    const [companyFax, setCompanyFax] = useState("");

    // NEW: Step 4 - Structured Address Fields
    const [addressStreet, setAddressStreet] = useState("");
    const [addressWard, setAddressWard] = useState("");
    const [addressDistrict, setAddressDistrict] = useState("");
    // selectedProvince already declared above

    // NEW: Step 9 - Payer Information
    const [payerName, setPayerName] = useState("");
    const [payerPhone, setPayerPhone] = useState("");
    const [payerEmail, setPayerEmail] = useState("");
    const [payerIDNumber, setPayerIDNumber] = useState("");
    const [payerAddress, setPayerAddress] = useState("");
    const [payerSameAsLegalRep, setPayerSameAsLegalRep] = useState(false);

    // NEW: Step 10 - Payment
    const [paymentMethod, setPaymentMethod] = useState<'qr' | 'transfer'>('qr');
    const [paymentCompleted, setPaymentCompleted] = useState(false);
    const [referenceNumber, setReferenceNumber] = useState("");
    const [registryCloseSignal, setRegistryCloseSignal] = useState<number>(0);

    const totalSteps = 10;
    const progressValue = currentStep === 'success' ? 100 : (Number(currentStep) / totalSteps) * 100;

    // Auto-translate Vietnamese name to English
    const handleTranslateName = async () => {
        if (!companyNameVi.trim()) return;

        try {
            // Call translation API
            const data = await api<{ translatedText: string }>("/api/translate", {
                method: "POST",
                body: JSON.stringify({
                    text: companyNameVi,
                    sourceLang: "vi",
                    targetLang: "en"
                })
            });

            setCompanyNameEn(data.translatedText.toUpperCase());
            toast.info("T√™n ti·∫øng Anh ƒë√£ ƒë∆∞·ª£c t·ª± ƒë·ªông ƒëi·ªÅn. B·∫°n c√≥ th·ªÉ ch·ªânh s·ª≠a.");
        } catch (error) {
            // Fallback: simple transformation if API fails
            console.error('[TRANSLATE ERROR]', error);
            const fallback = companyNameVi
                .toUpperCase()
                .replace(/C√îNG TY /g, '')
                .replace(/TNHH /g, '')
                .replace(/C·ªî PH·∫¶N /g, '')
                .trim() + ' COMPANY LIMITED';
            setCompanyNameEn(fallback);
            toast.info("T√™n ti·∫øng Anh ƒë√£ ƒë∆∞·ª£c t·ª± ƒë·ªông ƒëi·ªÅn (ch·∫ø ƒë·ªô offline). B·∫°n c√≥ th·ªÉ ch·ªânh s·ª≠a.");
        }
    };

    // Check name availability
    const handleCheckName = async () => {
        if (!companyNameVi.trim() || companyNameVi.trim().length < 3) {
            toast.error("Vui l√≤ng nh·∫≠p t√™n c√¥ng ty h·ª£p l·ªá (t·ªëi thi·ªÉu 3 k√Ω t·ª±)");
            return;
        }

        setIsCheckingName(true);
        setRegistryCloseSignal(Date.now()); // Close dropdown when checking
        try {
            const data = await api<any>("/api/check-name", {
                method: "POST",
                body: JSON.stringify({ companyName: companyNameVi })
            });

            if (data.status === 'available') {
                setNameAvailable(true);
                toast.success("T√™n kh·∫£ d·ª•ng!");
                await handleTranslateName();
            } else {
                setNameAvailable(false);
                toast.error(data.message || "T√™n ƒë√£ t·ªìn t·∫°i");
            }
        } catch (error) {
            toast.error("L·ªói khi ki·ªÉm tra t√™n");
            setNameAvailable(null);
        } finally {
            setIsCheckingName(false);
        }
    };

    // Check address for warnings
    useEffect(() => {
        const keywords = ['chung c∆∞', 'chung cu', 't·∫≠p th·ªÉ', 'tap the'];
        const hasKeyword = keywords.some(kw => address.toLowerCase().includes(kw));
        setAddressWarning(hasKeyword);
    }, [address]);

    // Auto-calculate founder percentages
    useEffect(() => {
        const capital = parseFloat(charterCapital.replace(/,/g, '')) || 0;
        if (capital > 0) {
            setFounders(prev => prev.map(f => ({
                ...f,
                ownershipPercentage: (f.capitalContribution / capital) * 100
            })));
        }
    }, [charterCapital, founders.map(f => f.capitalContribution).join(',')]);

    // Validate founders
    const isFoundersValid = () => {
        if (!businessType) return false;
        const selectedType = BUSINESS_TYPES.find(t => t.id === businessType);
        if (!selectedType) return false;

        const count = founders.length;
        if (count < selectedType.minMembers || count > selectedType.maxMembers) {
            return false;
        }

        const totalPercentage = founders.reduce((sum, f) => sum + f.ownershipPercentage, 0);
        return Math.abs(totalPercentage - 100) < 0.01; // Account for floating point errors
    };

    const addFounder = () => {
        const newFounder: Founder = {
            id: crypto.randomUUID(),
            name: "",
            idNumber: "",
            permanentAddress: "",
            contactAddress: "",
            capitalContribution: 0,
            ownershipPercentage: 0,
        };
        setFounders(prev => [...prev, newFounder]);
    };

    const removeFounder = (id: string) => {
        setFounders(prev => prev.filter(f => f.id !== id));
    };

    const updateFounder = (id: string, field: keyof Founder, value: any) => {
        setFounders(prev => prev.map(f =>
            f.id === id ? { ...f, [field]: value } : f
        ));
    };

    const handleSubmitFinal = async () => {
        if (!isAgreed) {
            toast.error("Vui l√≤ng ƒë·ªìng √Ω v·ªõi ƒëi·ªÅu kho·∫£n d·ªãch v·ª•");
            return;
        }

        setIsSubmitting(true);
        try {
            const payload = {
                businessType,
                companyNameVi,
                companyNameEn,
                abbreviation,
                address,
                phone: phone3,
                email: email3,
                website,
                fax,
                businessLines,
                vatMethod,
                charterCapital: parseFloat(charterCapital.replace(/,/g, '')) || 0,
                assetContribution,
                capitalCompletionDate,
                legalRepresentative: {
                    uploadedVNeID: legalRepMode === 'vneid',
                    name: legalRepName,
                    title: legalRepTitle,
                    dob: legalRepDOB,
                    ethnicity: legalRepEthnicity,
                    idNumber: legalRepIDNumber,
                    idIssueDate: legalRepIDDate,
                    idIssuePlace: legalRepIDPlace,
                    permanentAddress: legalRepPermanentAddress,
                    contactAddress: legalRepContactAddress,
                },
                hasChiefAccountant,
                chiefAccountant: hasChiefAccountant ? {
                    name: caName,
                    dob: caDOB,
                    idNumber: caIDNumber,
                    idIssueDate: caIDDate,
                    idIssuePlace: caIDPlace,
                    address: caAddress,
                } : undefined,
                founders,
                selectedPackageId,
            };

            // Mock submission - replace with actual API call
            console.log('[SUBMIT]', payload);
            await new Promise(resolve => setTimeout(resolve, 2000));

            const ref = `CONTI-${Math.random().toString(36).substring(2, 7).toUpperCase()}`;
            setReferenceNumber(ref);
            setCurrentStep('success');
            toast.success("G·ª≠i h·ªì s∆° th√†nh c√¥ng!");
        } catch (error) {
            toast.error("G·ª≠i h·ªì s∆° th·∫•t b·∫°i");
        } finally {
            setIsSubmitting(false);
        }
    };

    const handleBack = () => {
        if (currentStep === 'success') return;
        if (currentStep === 1) navigate(-1);
        else setCurrentStep((prev) => (Number(prev) - 1) as OnboardingStep);
    };

    const selectedPackage = PACKAGE_OPTIONS.find(p => p.id === selectedPackageId) || PACKAGE_OPTIONS[1];

    return (
        <div className="min-h-screen flex flex-col bg-background text-foreground">
            <Header />
            <main className="flex-grow flex flex-col">
                <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 w-full py-8 md:py-12">
                    {currentStep !== 'success' && (
                        <div className="max-w-5xl mx-auto mb-12">
                            <div className="flex items-center justify-between mb-4">
                                <Button variant="ghost" size="sm" onClick={handleBack} className="text-muted-foreground hover:text-foreground">
                                    <ArrowLeft className="mr-2 h-4 w-4" /> Quay l·∫°i
                                </Button>
                                <span className="text-sm font-bold text-blue-500">B∆∞·ªõc {currentStep}/{totalSteps}</span>
                            </div>
                            <Progress value={progressValue} className="h-2 bg-blue-100" />
                        </div>
                    )}

                    <AnimatePresence mode="wait">
                        {/* STEP 1: Choose Province (NEW) */}
                        {currentStep === 1 && (
                            <motion.div key="step1" initial={{ opacity: 0, y: 10 }} animate={{ opacity: 1, y: 0 }} exit={{ opacity: 0, y: -10 }} className="space-y-10 max-w-5xl mx-auto">
                                <div className="text-center space-y-4">
                                    <h1 className="text-4xl md:text-5xl font-display font-bold text-brand-navy">
                                        Ch·ªçn t·ªânh/th√†nh ph·ªë n∆°i th√†nh l·∫≠p doanh nghi·ªáp
                                    </h1>
                                    <p className="text-lg text-muted-foreground">
                                        ƒê·ªãa ƒëi·ªÉm ƒëƒÉng k√Ω kinh doanh c·ªßa c√¥ng ty b·∫°n
                                    </p>
                                </div>

                                <Card className="p-8 max-w-2xl mx-auto">
                                    <div className="space-y-4">
                                        <Label className="text-lg font-bold">
                                            T·ªânh/Th√†nh ph·ªë *
                                        </Label>
                                        <select
                                            value={selectedProvince}
                                            onChange={(e) => setSelectedProvince(e.target.value)}
                                            className="w-full h-14 px-4 text-lg border-2 rounded-lg border-input bg-background hover:border-blue-500 focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20 outline-none transition-all"
                                        >
                                            <option value="">-- Ch·ªçn t·ªânh/th√†nh ph·ªë --</option>
                                            {VIETNAM_PROVINCES.map(province => (
                                                <option key={province.id} value={province.id}>
                                                    {province.name}
                                                </option>
                                            ))}
                                        </select>
                                        <p className="text-sm text-muted-foreground">
                                            üí° ƒê√¢y l√† n∆°i c√¥ng ty s·∫Ω ƒëƒÉng k√Ω kinh doanh ch√≠nh th·ª©c
                                        </p>
                                    </div>
                                </Card>

                                <div className="flex justify-center pt-4">
                                    <Button
                                        onClick={() => setCurrentStep(2)}
                                        disabled={!selectedProvince}
                                        className="h-14 px-16 bg-blue-600 text-lg font-bold rounded-xl shadow-xl hover:bg-blue-700"
                                    >
                                        Ti·∫øp t·ª•c <ArrowRight className="ml-2 h-5 w-5" />
                                    </Button>
                                </div>
                            </motion.div>
                        )}

                        {/* STEP 2: Choose Business Type (was Step 1) */}
                        {currentStep === 2 && (
                            <motion.div key="step2" initial={{ opacity: 0, y: 10 }} animate={{ opacity: 1, y: 0 }} exit={{ opacity: 0, y: -10 }} className="space-y-10 max-w-5xl mx-auto">
                                <div className="text-center space-y-4">
                                    <h1 className="text-4xl md:text-5xl font-display font-bold text-brand-navy">Ch·ªçn lo·∫°i h√¨nh doanh nghi·ªáp</h1>
                                    <p className="text-lg text-muted-foreground">Lo·∫°i h√¨nh ph√°p l√Ω ph√π h·ª£p v·ªõi m√¥ h√¨nh kinh doanh c·ªßa b·∫°n</p>
                                </div>

                                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                    {BUSINESS_TYPES.map((type) => (
                                        <Card
                                            key={type.id}
                                            className={cn(
                                                "cursor-pointer border-2 transition-all p-8 hover:shadow-xl",
                                                businessType === type.id ? "border-blue-500 bg-blue-50/20 ring-2 ring-blue-500" : "hover:border-blue-200"
                                            )}
                                            onClick={() => setBusinessType(type.id)}
                                        >
                                            <div className="flex justify-between items-start mb-4">
                                                <h3 className="text-lg font-bold text-brand-navy">{type.name}</h3>
                                                {type.recommended && <Badge className="bg-blue-600">Ph·ªï bi·∫øn</Badge>}
                                            </div>
                                            <p className="text-sm text-muted-foreground italic mb-4">{type.description}</p>

                                            {/* Benefits */}
                                            {type.benefits && (
                                                <div className="mt-4 space-y-1">
                                                    <p className="text-xs font-semibold text-green-700">L·ª£i √≠ch:</p>
                                                    {type.benefits.map((benefit, i) => (
                                                        <p key={i} className="text-xs text-green-600">{benefit}</p>
                                                    ))}
                                                </div>
                                            )}

                                            {/* Limitations */}
                                            {type.limitations && (
                                                <div className="mt-2 space-y-1">
                                                    <p className="text-xs font-semibold text-orange-700">H·∫°n ch·∫ø:</p>
                                                    {type.limitations.map((limit, i) => (
                                                        <p key={i} className="text-xs text-orange-600">{limit}</p>
                                                    ))}
                                                </div>
                                            )}

                                            <div className="text-sm mt-4">
                                                <p className="font-medium">
                                                    S·ªë th√†nh vi√™n: {type.minMembers === type.maxMembers ? type.minMembers : `${type.minMembers}-${type.maxMembers === Infinity ? 'Kh√¥ng gi·ªõi h·∫°n' : type.maxMembers}`}
                                                </p>
                                            </div>
                                        </Card>
                                    ))}
                                </div>

                                <div className="flex justify-between pt-4">
                                    <Button
                                        variant="outline"
                                        onClick={() => setCurrentStep(1)}
                                        className="h-14 px-8"
                                    >
                                        <ArrowLeft className="mr-2 h-5 w-5" /> Quay l·∫°i
                                    </Button>
                                    <Button
                                        onClick={() => setCurrentStep(3)}
                                        disabled={!businessType}
                                        className="h-14 px-16 bg-blue-600 text-lg font-bold rounded-xl shadow-xl hover:bg-blue-700"
                                    >
                                        Ti·∫øp t·ª•c <ArrowRight className="ml-2 h-5 w-5" />
                                    </Button>
                                </div>
                            </motion.div>
                        )}

                        {/* STEP 3: Company Naming (was Step 2) */}
                        {currentStep === 3 && (
                            <motion.div key="step3-naming" initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }} className="space-y-10 max-w-3xl mx-auto">
                                <div className="text-center space-y-4">
                                    <h2 className="text-3xl font-display font-bold text-brand-navy">Th√¥ng tin t√™n C√¥ng ty</h2>
                                    <p className="text-muted-foreground">Kh√¥ng tr√πng t√™n ƒë√£ c√≥</p>
                                </div>

                                <Card className="p-8 space-y-6">
                                    <div className="space-y-2">
                                        <Label className="font-bold">T√™n ti·∫øng Vi·ªát *</Label>
                                        <div className="relative">
                                            <Input
                                                value={companyNameVi}
                                                onChange={(e) => {
                                                    setCompanyNameVi(e.target.value.toUpperCase());
                                                    setNameAvailable(null);
                                                }}
                                                placeholder="VD: AD FLEX"
                                                className="h-14 text-lg font-bold pr-32"
                                            />
                                            <Button
                                                onClick={handleCheckName}
                                                disabled={isCheckingName || companyNameVi.length < 3}
                                                className="absolute right-2 top-2 h-10 px-6 bg-blue-600 hover:bg-blue-700"
                                            >
                                                {isCheckingName ? <Loader2 className="animate-spin" /> : "Ki·ªÉm tra"}
                                            </Button>
                                            <CompanyRegistrySearch
                                                query={companyNameVi}
                                                onSelect={(entry) => {
                                                    setCompanyNameVi(entry.name.toUpperCase());
                                                    setNameAvailable(null);
                                                    setRegistryCloseSignal(Date.now());
                                                }}
                                                closeSignal={registryCloseSignal}
                                            />
                                        </div>
                                        {nameAvailable === true && (
                                            <div className="flex items-center gap-2 text-green-600 text-sm font-medium">
                                                <CheckCircle2 className="h-4 w-4" />
                                                T√™n kh·∫£ d·ª•ng!
                                            </div>
                                        )}
                                        {nameAvailable === false && (
                                            <div className="flex items-center gap-2 text-red-600 text-sm font-medium">
                                                <AlertCircle className="h-4 w-4" />
                                                T√™n ƒë√£ t·ªìn t·∫°i, vui l√≤ng ch·ªçn t√™n kh√°c
                                            </div>
                                        )}
                                    </div>

                                    <div className="space-y-2">
                                        <Label className="font-bold">T√™n giao d·ªãch qu·ªëc t·∫ø (International Name) *</Label>
                                        <Input
                                            value={companyNameEn}
                                            onChange={(e) => setCompanyNameEn(e.target.value.toUpperCase())}
                                            placeholder="AD FLEX COMPANY LIMITED"
                                            className="h-14 text-lg"
                                        />
                                        <p className="text-xs text-muted-foreground">ƒê∆∞·ª£c t·ª± ƒë·ªông ƒëi·ªÅn sau khi ki·ªÉm tra t√™n. B·∫°n c√≥ th·ªÉ ch·ªânh s·ª≠a.</p>
                                    </div>

                                    <div className="space-y-2">
                                        <Label className="font-bold">T√™n vi·∫øt t·∫Øt (t√πy ch·ªçn)</Label>
                                        <Input
                                            value={abbreviation}
                                            onChange={(e) => setAbbreviation(e.target.value.toUpperCase())}
                                            placeholder="VD: ADFCO"
                                            className="h-14"
                                        />
                                    </div>
                                </Card>

                                <div className="flex justify-between pt-4">
                                    <Button
                                        variant="outline"
                                        onClick={() => setCurrentStep(2)}
                                        className="h-14 px-8"
                                    >
                                        <ArrowLeft className="mr-2 h-5 w-5" /> Quay l·∫°i
                                    </Button>
                                    <Button
                                        onClick={() => setCurrentStep(4)}
                                        disabled={!nameAvailable || !companyNameVi || !companyNameEn}
                                        className="h-14 px-16 bg-blue-600 text-lg font-bold rounded-xl shadow-xl hover:bg-blue-700"
                                    >
                                        Ti·∫øp t·ª•c <ArrowRight className="ml-2 h-5 w-5" />
                                    </Button>
                                </div>
                            </motion.div>
                        )}

                        {/* STEP 4: Contact Info + Address */}
                        {currentStep === 4 && (
                            <motion.div key="step4-contact" initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }} className="space-y-8 max-w-4xl mx-auto">
                                <div className="text-center space-y-4">
                                    <h2 className="text-3xl font-display font-bold text-brand-navy">Th√¥ng tin li√™n l·∫°c & Tr·ª• s·ªü</h2>
                                    <p className="text-muted-foreground">Th√¥ng tin li√™n l·∫°c c·ªßa c√¥ng ty v√† ƒë·ªãa ch·ªâ tr·ª• s·ªü ch√≠nh</p>
                                </div>

                                <Card className="p-8 space-y-8">
                                    {/* SECTION 1: Company Contact Info */}
                                    <div className="space-y-4">
                                        <h3 className="text-xl font-bold text-brand-navy">Th√¥ng tin li√™n l·∫°c c√¥ng ty</h3>
                                        <p className="text-sm text-muted-foreground">Th√¥ng tin n√†y c√≥ th·ªÉ tr√πng ho·∫∑c kh√¥ng tr√πng v·ªõi ng∆∞·ªùi ƒë·∫°i di·ªán ph√°p lu·∫≠t</p>

                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div className="space-y-2">
                                                <Label className="font-bold">S·ªë ƒëi·ªán tho·∫°i *</Label>
                                                <div className="relative">
                                                    <Phone className="absolute left-3 top-3.5 h-5 w-5 text-muted-foreground" />
                                                    <Input
                                                        type="tel"
                                                        value={companyPhone}
                                                        onChange={(e) => setCompanyPhone(e.target.value)}
                                                        placeholder="09xx xxx xxx"
                                                        className="h-12 pl-10"
                                                    />
                                                </div>
                                            </div>

                                            <div className="space-y-2">
                                                <Label className="font-bold">Email *</Label>
                                                <div className="relative">
                                                    <Mail className="absolute left-3 top-3.5 h-5 w-5 text-muted-foreground" />
                                                    <Input
                                                        type="email"
                                                        value={companyEmail}
                                                        onChange={(e) => setCompanyEmail(e.target.value)}
                                                        placeholder="contact@company.com"
                                                        className="h-12 pl-10"
                                                    />
                                                </div>

                                                {/* Microsoft 365 Suggestion */}
                                                <div className="mt-2 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                                                    <div className="flex gap-2 text-sm">
                                                        <div className="shrink-0 text-blue-600">üí°</div>
                                                        <div>
                                                            <p className="font-medium text-blue-900">G·ª£i √Ω chuy√™n nghi·ªáp</p>
                                                            <p className="text-blue-700 mt-1">
                                                                N√™n s·ª≠ d·ª•ng email doanh nghi·ªáp ri√™ng (vd: info@congty.com) thay v√¨ email c√° nh√¢n.
                                                                <Link to="/services/microsoft-365" className="font-bold text-blue-600 hover:underline ml-1">
                                                                    CONTI cung c·∫•p t√†i kho·∫£n Microsoft 365 Business
                                                                </Link>
                                                            </p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div className="space-y-2">
                                                <Label>Website (t√πy ch·ªçn)</Label>
                                                <div className="relative">
                                                    <Globe className="absolute left-3 top-3.5 h-5 w-5 text-muted-foreground" />
                                                    <Input
                                                        value={companyWebsite}
                                                        onChange={(e) => setCompanyWebsite(e.target.value)}
                                                        placeholder="www.company.com"
                                                        className="h-12 pl-10"
                                                    />
                                                </div>
                                            </div>

                                            <div className="space-y-2">
                                                <Label>Fax (t√πy ch·ªçn)</Label>
                                                <div className="relative">
                                                    <Printer className="absolute left-3 top-3.5 h-5 w-5 text-muted-foreground" />
                                                    <Input
                                                        value={companyFax}
                                                        onChange={(e) => setCompanyFax(e.target.value)}
                                                        placeholder="024 xxxx xxxx"
                                                        className="h-12 pl-10"
                                                    />
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    {/* Separator */}
                                    <div className="border-t border-gray-200"></div>

                                    {/* SECTION 2: Headquarters Address */}
                                    <div className="space-y-4">
                                        <h3 className="text-xl font-bold text-brand-navy">ƒê·ªãa ch·ªâ tr·ª• s·ªü doanh nghi·ªáp</h3>

                                        {/* Selected Province (read-only from Step 1) */}
                                        <div className="p-4 bg-blue-50 rounded-lg">
                                            <p className="text-sm font-medium text-gray-700">
                                                T·ªânh/Th√†nh ph·ªë: <span className="text-blue-600 font-bold">
                                                    {VIETNAM_PROVINCES.find(p => p.id === selectedProvince)?.name || 'Ch∆∞a ch·ªçn'}
                                                </span>
                                            </p>
                                            <p className="text-xs text-muted-foreground mt-1">
                                                (ƒê√£ ch·ªçn ·ªü b∆∞·ªõc 1.
                                                <button
                                                    onClick={() => setCurrentStep(1)}
                                                    className="text-blue-600 hover:underline ml-1"
                                                >
                                                    Mu·ªën thay ƒë·ªïi? Quay l·∫°i b∆∞·ªõc 1
                                                </button>)
                                            </p>
                                        </div>

                                        {/* District & Ward */}
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div className="space-y-2">
                                                <Label className="font-bold">Qu·∫≠n/Huy·ªán *</Label>
                                                <Input
                                                    value={addressDistrict}
                                                    onChange={(e) => setAddressDistrict(e.target.value)}
                                                    placeholder="VD: Qu·∫≠n Ba ƒê√¨nh"
                                                    className="h-12"
                                                />
                                            </div>

                                            <div className="space-y-2">
                                                <Label className="font-bold">Ph∆∞·ªùng/X√£ *</Label>
                                                <Input
                                                    value={addressWard}
                                                    onChange={(e) => setAddressWard(e.target.value)}
                                                    placeholder="VD: Ph∆∞·ªùng ƒêi·ªán Bi√™n"
                                                    className="h-12"
                                                />
                                            </div>
                                        </div>

                                        {/* Street Address */}
                                        <div className="space-y-2">
                                            <Label className="font-bold">S·ªë nh√†, t√™n ƒë∆∞·ªùng *</Label>
                                            <Input
                                                value={addressStreet}
                                                onChange={(e) => {
                                                    setAddressStreet(e.target.value);
                                                    // Check for warning keywords
                                                    const warning = /chung c∆∞|t·∫≠p th·ªÉ|apartment/i.test(e.target.value);
                                                    setAddressWarning(warning);
                                                }}
                                                placeholder="VD: S·ªë 54 Li·ªÖu Giai"
                                                className="h-12"
                                            />
                                        </div>

                                        {/* Full Address Preview */}
                                        <div className="p-4 bg-gray-50 rounded-lg">
                                            <p className="text-sm font-medium text-gray-700 mb-1">ƒê·ªãa ch·ªâ ƒë·∫ßy ƒë·ªß:</p>
                                            <p className="text-sm text-gray-900 font-medium">
                                                {[
                                                    addressStreet,
                                                    addressWard,
                                                    addressDistrict,
                                                    VIETNAM_PROVINCES.find(p => p.id === selectedProvince)?.name
                                                ]
                                                    .filter(Boolean)
                                                    .join(', ') || 'Ch∆∞a ƒëi·ªÅn ƒë·ªß th√¥ng tin'}
                                            </p>
                                        </div>

                                        {/* Warning for apartments */}
                                        {addressWarning && (
                                            <div className="p-3 bg-yellow-50 border border-yellow-200 rounded-lg flex gap-2">
                                                <AlertCircle className="h-5 w-5 text-yellow-600 shrink-0 mt-0.5" />
                                                <div className="text-sm text-yellow-800">
                                                    <strong>L∆∞u √Ω:</strong> Tr·ª• s·ªü kh√¥ng ƒë∆∞·ª£c ph√©p l√† chung c∆∞/nh√† t·∫≠p th·ªÉ.
                                                    N·∫øu l√† nh√† ri√™ng c√≥ s·ªë ph√≤ng, c·∫ßn c√≥ Gi·∫•y ch·ª©ng nh·∫≠n quy·ªÅn s·ª≠ d·ª•ng ƒë·∫•t.
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                </Card>

                                <div className="flex justify-between pt-4">
                                    <Button
                                        variant="outline"
                                        onClick={() => setCurrentStep(3)}
                                        className="h-14 px-8"
                                    >
                                        <ArrowLeft className="mr-2 h-5 w-5" /> Quay l·∫°i
                                    </Button>
                                    <Button
                                        onClick={() => setCurrentStep(5)}
                                        disabled={!companyPhone || !companyEmail || !addressStreet || !addressWard || !addressDistrict}
                                        className="h-14 px-16 bg-blue-600 text-lg font-bold rounded-xl shadow-xl hover:bg-blue-700"
                                    >
                                        Ti·∫øp t·ª•c <ArrowRight className="ml-2 h-5 w-5" />
                                    </Button>
                                </div>
                            </motion.div>
                        )}

                        {/* STEP 4: Business Details */}
                        {currentStep === 5 && (
                            <motion.div key="step4" initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }} className="space-y-10 max-w-3xl mx-auto">
                                <div className="text-center space-y-4">
                                    <h2 className="text-3xl font-display font-bold text-brand-navy">Ng√†nh ngh·ªÅ & Thu·∫ø</h2>
                                    <p className="text-muted-foreground">Lƒ©nh v·ª±c ho·∫°t ƒë·ªông v√† ph∆∞∆°ng ph√°p t√≠nh thu·∫ø</p>
                                </div>

                                <Card className="p-8 space-y-6">
                                    <div className="space-y-2">
                                        <Label className="font-bold">Ng√†nh ngh·ªÅ kinh doanh *</Label>
                                        <Textarea
                                            value={businessLines}
                                            onChange={(e) => setBusinessLines(e.target.value)}
                                            placeholder="Li·ªát k√™ lƒ©nh v·ª±c ho·∫°t ƒë·ªông theo t·ª´ ng·ªØ th√¥ng th∆∞·ªùng, VD: Th∆∞∆°ng m·∫°i ƒëi·ªán t·ª≠, T∆∞ v·∫•n qu·∫£n tr·ªã, Ph√°t tri·ªÉn ph·∫ßn m·ªÅm..."
                                            rows={5}
                                            className="resize-none"
                                        />
                                    </div>

                                    <div className="space-y-4">
                                        <Label className="font-bold">Ph∆∞∆°ng ph√°p t√≠nh thu·∫ø GTGT *</Label>
                                        <RadioGroup value={vatMethod} onValueChange={(v) => setVATMethod(v as VATMethod)}>
                                            <div className="flex items-center space-x-2 p-3 border rounded-lg hover:bg-blue-50 cursor-pointer">
                                                <RadioGroupItem value="khau-tru" id="vat1" />
                                                <Label htmlFor="vat1" className="cursor-pointer flex-grow">Kh·∫•u tr·ª´ (M·∫∑c ƒë·ªãnh)</Label>
                                            </div>
                                            <div className="flex items-center space-x-2 p-3 border rounded-lg hover:bg-blue-50 cursor-pointer">
                                                <RadioGroupItem value="truc-tiep-gtgt" id="vat2" />
                                                <Label htmlFor="vat2" className="cursor-pointer flex-grow">Tr·ª±c ti·∫øp tr√™n GTGT</Label>
                                            </div>
                                            <div className="flex items-center space-x-2 p-3 border rounded-lg hover:bg-blue-50 cursor-pointer">
                                                <RadioGroupItem value="truc-tiep-doanh-so" id="vat3" />
                                                <Label htmlFor="vat3" className="cursor-pointer flex-grow">Tr·ª±c ti·∫øp tr√™n doanh s·ªë</Label>
                                            </div>
                                            <div className="flex items-center space-x-2 p-3 border rounded-lg hover:bg-blue-50 cursor-pointer">
                                                <RadioGroupItem value="khong-nop" id="vat4" />
                                                <Label htmlFor="vat4" className="cursor-pointer flex-grow">Kh√¥ng ph·∫£i n·ªôp thu·∫ø GTGT</Label>
                                            </div>
                                        </RadioGroup>
                                    </div>
                                </Card>

                                <div className="flex justify-center pt-4">
                                    <Button
                                        onClick={() => setCurrentStep(5)}
                                        disabled={!businessLines.trim()}
                                        className="h-14 px-16 bg-blue-600 text-lg font-bold rounded-xl shadow-xl hover:bg-blue-700"
                                    >
                                        Ti·∫øp t·ª•c <ArrowRight className="ml-2 h-5 w-5" />
                                    </Button>
                                </div>
                            </motion.div>
                        )}

                        {/* STEP 5: Capital & Personnel */}
                        {currentStep === 6 && (
                            <motion.div key="step5" initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }} className="space-y-10 max-w-4xl mx-auto">
                                <div className="text-center space-y-4">
                                    <h2 className="text-3xl font-display font-bold text-brand-navy">V·ªën & Nh√¢n s·ª±</h2>
                                    <p className="text-muted-foreground">Th√¥ng tin v·ªÅ v·ªën ƒëi·ªÅu l·ªá v√† ng∆∞·ªùi ƒë·∫°i di·ªán ph√°p lu·∫≠t</p>
                                </div>

                                <Card className="p-8 space-y-8">
                                    {/* Capital Information */}
                                    <div className="space-y-6">
                                        <h3 className="text-xl font-bold flex items-center gap-2">
                                            <DollarSign className="h-6 w-6 text-blue-600" />
                                            Th√¥ng tin v·ªën
                                        </h3>

                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                            <div className="space-y-2">
                                                <Label className="font-bold">V·ªën ƒëi·ªÅu l·ªá (VNƒê) *</Label>
                                                <Input
                                                    type="text"
                                                    value={charterCapital}
                                                    onChange={(e) => {
                                                        const value = e.target.value.replace(/[^0-9]/g, '');
                                                        setCharterCapital(value ? parseInt(value).toLocaleString('vi-VN') : '');
                                                    }}
                                                    placeholder="50,000,000"
                                                    className="h-12 text-lg font-bold"
                                                />
                                            </div>

                                            <div className="space-y-2">
                                                <Label className="font-bold">Th·ªùi ƒëi·ªÉm ho√†n th√†nh g√≥p v·ªën *</Label>
                                                <Input
                                                    type="date"
                                                    value={capitalCompletionDate}
                                                    onChange={(e) => setCapitalCompletionDate(e.target.value)}
                                                    className="h-12"
                                                />
                                            </div>
                                        </div>

                                        <div className="space-y-2">
                                            <Label className="font-bold">T√†i s·∫£n g√≥p v·ªën *</Label>
                                            <RadioGroup value={assetContribution} onValueChange={(v) => setAssetContribution(v as AssetContribution)}>
                                                <div className="flex items-center space-x-2 p-3 border rounded-lg hover:bg-blue-50">
                                                    <RadioGroupItem value="cash" id="asset1" />
                                                    <Label htmlFor="asset1" className="cursor-pointer flex-grow">Ti·ªÅn m·∫∑t</Label>
                                                </div>
                                                <div className="flex items-center space-x-2 p-3 border rounded-lg hover:bg-blue-50">
                                                    <RadioGroupItem value="bank-transfer" id="asset2" />
                                                    <Label htmlFor="asset2" className="cursor-pointer flex-grow">Chuy·ªÉn kho·∫£n</Label>
                                                </div>
                                            </RadioGroup>
                                        </div>
                                    </div>

                                    <div className="border-t pt-6" />

                                    {/* Legal Representative */}
                                    <div className="space-y-6">
                                        <h3 className="text-xl font-bold flex items-center gap-2">
                                            <User className="h-6 w-6 text-blue-600" />
                                            Ng∆∞·ªùi ƒë·∫°i di·ªán theo ph√°p lu·∫≠t
                                        </h3>

                                        <div className="flex gap-4">
                                            <Button
                                                variant={legalRepMode === 'vneid' ? 'default' : 'outline'}
                                                onClick={() => setLegalRepMode('vneid')}
                                                className="flex-1"
                                            >
                                                <Upload className="mr-2 h-4 w-4" />
                                                Upload ·∫£nh CCCD t·ª´ VNeID
                                            </Button>
                                            <Button
                                                variant={legalRepMode === 'manual' ? 'default' : 'outline'}
                                                onClick={() => setLegalRepMode('manual')}
                                                className="flex-1"
                                            >
                                                Nh·∫≠p tay
                                            </Button>
                                        </div>

                                        {legalRepMode === 'vneid' && (
                                            <div className="p-6 border-2 border-dashed rounded-lg text-center bg-blue-50/50">
                                                <Upload className="h-12 w-12 mx-auto text-blue-600 mb-3" />
                                                <p className="font-medium mb-2">T·∫£i l√™n ·∫£nh CCCD 2 m·∫∑t</p>
                                                <p className="text-sm text-muted-foreground">H·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông tr√≠ch xu·∫•t th√¥ng tin</p>
                                                <Button variant="outline" className="mt-4">Ch·ªçn ·∫£nh</Button>
                                            </div>
                                        )}

                                        {legalRepMode === 'manual' && (
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                                <div className="space-y-2">
                                                    <Label className="font-bold">H·ªç v√† t√™n *</Label>
                                                    <Input
                                                        value={legalRepName}
                                                        onChange={(e) => setLegalRepName(e.target.value.toUpperCase())}
                                                        placeholder="NGUY·ªÑN VƒÇN A"
                                                        className="h-12"
                                                    />
                                                </div>
                                                <div className="space-y-2">
                                                    <Label className="font-bold">Ch·ª©c v·ª• *</Label>
                                                    <Input
                                                        value={legalRepTitle}
                                                        onChange={(e) => setLegalRepTitle(e.target.value)}
                                                        placeholder="Gi√°m ƒë·ªëc"
                                                        className="h-12"
                                                    />
                                                </div>
                                                <div className="space-y-2">
                                                    <Label className="font-bold">Ng√†y sinh *</Label>
                                                    <Input
                                                        type="date"
                                                        value={legalRepDOB}
                                                        onChange={(e) => setLegalRepDOB(e.target.value)}
                                                        className="h-12"
                                                    />
                                                </div>
                                                <div className="space-y-2">
                                                    <Label className="font-bold">D√¢n t·ªôc</Label>
                                                    <Input
                                                        value={legalRepEthnicity}
                                                        onChange={(e) => setLegalRepEthnicity(e.target.value)}
                                                        placeholder="Kinh"
                                                        className="h-12"
                                                    />
                                                </div>
                                                <div className="space-y-2">
                                                    <Label className="font-bold">S·ªë CCCD/CMND *</Label>
                                                    <Input
                                                        value={legalRepIDNumber}
                                                        onChange={(e) => setLegalRepIDNumber(e.target.value)}
                                                        placeholder="001234567890"
                                                        className="h-12"
                                                    />
                                                </div>
                                                <div className="space-y-2">
                                                    <Label className="font-bold">Ng√†y c·∫•p *</Label>
                                                    <Input
                                                        type="date"
                                                        value={legalRepIDDate}
                                                        onChange={(e) => setLegalRepIDDate(e.target.value)}
                                                        className="h-12"
                                                    />
                                                </div>
                                                <div className="space-y-2 md:col-span-2">
                                                    <Label className="font-bold">N∆°i c·∫•p *</Label>
                                                    <Input
                                                        value={legalRepIDPlace}
                                                        onChange={(e) => setLegalRepIDPlace(e.target.value)}
                                                        placeholder="C·ª•c C·∫£nh s√°t ƒêKQL c∆∞ tr√∫ v√† DLQG v·ªÅ d√¢n c∆∞"
                                                        className="h-12"
                                                    />
                                                </div>
                                                <div className="space-y-2 md:col-span-2">
                                                    <Label className="font-bold">ƒê·ªãa ch·ªâ th∆∞·ªùng tr√∫ *</Label>
                                                    <Textarea
                                                        value={legalRepPermanentAddress}
                                                        onChange={(e) => setLegalRepPermanentAddress(e.target.value)}
                                                        rows={2}
                                                        className="resize-none"
                                                    />
                                                </div>
                                                <div className="space-y-2 md:col-span-2">
                                                    <Label className="font-bold">ƒê·ªãa ch·ªâ li√™n h·ªá *</Label>
                                                    <Textarea
                                                        value={legalRepContactAddress}
                                                        onChange={(e) => setLegalRepContactAddress(e.target.value)}
                                                        rows={2}
                                                        className="resize-none"
                                                    />
                                                </div>
                                            </div>
                                        )}
                                    </div>

                                    <div className="border-t pt-6" />

                                    {/* Chief Accountant */}
                                    <div className="space-y-6">
                                        <div className="flex items-center justify-between">
                                            <h3 className="text-xl font-bold">K·∫ø to√°n tr∆∞·ªüng</h3>
                                            <div className="flex items-center gap-2">
                                                <Label htmlFor="has-ca">C√≥ ƒëƒÉng k√Ω K·∫ø to√°n tr∆∞·ªüng?</Label>
                                                <Checkbox
                                                    id="has-ca"
                                                    checked={hasChiefAccountant}
                                                    onCheckedChange={(v) => setHasChiefAccountant(!!v)}
                                                />
                                            </div>
                                        </div>

                                        {hasChiefAccountant && (
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6 p-6 bg-blue-50/30 rounded-lg">
                                                <div className="space-y-2">
                                                    <Label className="font-bold">H·ªç v√† t√™n *</Label>
                                                    <Input
                                                        value={caName}
                                                        onChange={(e) => setCAName(e.target.value.toUpperCase())}
                                                        className="h-12"
                                                    />
                                                </div>
                                                <div className="space-y-2">
                                                    <Label className="font-bold">Ng√†y sinh *</Label>
                                                    <Input
                                                        type="date"
                                                        value={caDOB}
                                                        onChange={(e) => setCADOB(e.target.value)}
                                                        className="h-12"
                                                    />
                                                </div>
                                                <div className="space-y-2">
                                                    <Label className="font-bold">S·ªë CCCD *</Label>
                                                    <Input
                                                        value={caIDNumber}
                                                        onChange={(e) => setCAIDNumber(e.target.value)}
                                                        className="h-12"
                                                    />
                                                </div>
                                                <div className="space-y-2">
                                                    <Label className="font-bold">Ng√†y c·∫•p *</Label>
                                                    <Input
                                                        type="date"
                                                        value={caIDDate}
                                                        onChange={(e) => setCAIDDate(e.target.value)}
                                                        className="h-12"
                                                    />
                                                </div>
                                                <div className="space-y-2 md:col-span-2">
                                                    <Label className="font-bold">N∆°i c·∫•p *</Label>
                                                    <Input
                                                        value={caIDPlace}
                                                        onChange={(e) => setCAIDPlace(e.target.value)}
                                                        className="h-12"
                                                    />
                                                </div>
                                                <div className="space-y-2 md:col-span-2">
                                                    <Label className="font-bold">ƒê·ªãa ch·ªâ *</Label>
                                                    <Textarea
                                                        value={caAddress}
                                                        onChange={(e) => setCAAddress(e.target.value)}
                                                        rows={2}
                                                        className="resize-none"
                                                    />
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                </Card>

                                <div className="flex justify-center pt-4">
                                    <Button
                                        onClick={() => setCurrentStep(6)}
                                        disabled={!charterCapital || !capitalCompletionDate || !legalRepName}
                                        className="h-14 px-16 bg-blue-600 text-lg font-bold rounded-xl shadow-xl hover:bg-blue-700"
                                    >
                                        Ti·∫øp t·ª•c <ArrowRight className="ml-2 h-5 w-5" />
                                    </Button>
                                </div>
                            </motion.div>
                        )}

                        {/* STEP 6: Founders/Shareholders */}
                        {currentStep === 7 && (
                            <motion.div key="step6" initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }} className="space-y-10 max-w-5xl mx-auto">
                                <div className="text-center space-y-4">
                                    <h2 className="text-3xl font-display font-bold text-brand-navy">S√°ng l·∫≠p vi√™n / C·ªï ƒë√¥ng</h2>
                                    <p className="text-muted-foreground">
                                        Th√¥ng tin c√°c th√†nh vi√™n g√≥p v·ªën
                                        {businessType && ` - Y√™u c·∫ßu: ${BUSINESS_TYPES.find(t => t.id === businessType)?.minMembers || 1}+ th√†nh vi√™n`}
                                    </p>
                                </div>

                                <Card className="p-8 space-y-6">
                                    {founders.length === 0 && (
                                        <div className="text-center py-12 text-muted-foreground">
                                            <Users className="h-16 w-16 mx-auto mb-4 opacity-50" />
                                            <p>Ch∆∞a c√≥ th√†nh vi√™n n√†o. Nh·∫•n "Th√™m th√†nh vi√™n" ƒë·ªÉ b·∫Øt ƒë·∫ßu.</p>
                                        </div>
                                    )}

                                    {founders.map((founder, index) => (
                                        <div key={founder.id} className="p-6 border-2 rounded-lg bg-slate-50 relative">
                                            <div className="flex justify-between items-center mb-4">
                                                <h3 className="font-bold text-lg">Th√†nh vi√™n #{index + 1}</h3>
                                                <Button
                                                    variant="ghost"
                                                    size="sm"
                                                    onClick={() => removeFounder(founder.id)}
                                                    className="text-red-600 hover:text-red-700 hover:bg-red-50"
                                                >
                                                    <X className="h-4 w-4 mr-1" />
                                                    X√≥a
                                                </Button>
                                            </div>

                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                <div className="space-y-2">
                                                    <Label className="text-sm font-bold">H·ªç v√† t√™n *</Label>
                                                    <Input
                                                        value={founder.name}
                                                        onChange={(e) => updateFounder(founder.id, 'name', e.target.value.toUpperCase())}
                                                        placeholder="NGUY·ªÑN VƒÇN A"
                                                    />
                                                </div>
                                                <div className="space-y-2">
                                                    <Label className="text-sm font-bold">S·ªë CCCD *</Label>
                                                    <Input
                                                        value={founder.idNumber}
                                                        onChange={(e) => updateFounder(founder.id, 'idNumber', e.target.value)}
                                                        placeholder="001234567890"
                                                    />
                                                </div>
                                                <div className="space-y-2 md:col-span-2">
                                                    <Label className="text-sm font-bold">ƒê·ªãa ch·ªâ th∆∞·ªùng tr√∫ *</Label>
                                                    <Textarea
                                                        value={founder.permanentAddress}
                                                        onChange={(e) => updateFounder(founder.id, 'permanentAddress', e.target.value)}
                                                        rows={2}
                                                        className="resize-none"
                                                    />
                                                </div>
                                                <div className="space-y-2 md:col-span-2">
                                                    <Label className="text-sm font-bold">ƒê·ªãa ch·ªâ li√™n h·ªá *</Label>
                                                    <Textarea
                                                        value={founder.contactAddress}
                                                        onChange={(e) => updateFounder(founder.id, 'contactAddress', e.target.value)}
                                                        rows={2}
                                                        className="resize-none"
                                                    />
                                                </div>
                                                <div className="space-y-2">
                                                    <Label className="text-sm font-bold">S·ªë v·ªën g√≥p (VNƒê) *</Label>
                                                    <Input
                                                        type="text"
                                                        value={founder.capitalContribution.toLocaleString('vi-VN')}
                                                        onChange={(e) => {
                                                            const value = e.target.value.replace(/[^0-9]/g, '');
                                                            updateFounder(founder.id, 'capitalContribution', parseInt(value) || 0);
                                                        }}
                                                        placeholder="10,000,000"
                                                    />
                                                </div>
                                                <div className="space-y-2">
                                                    <Label className="text-sm font-bold">T·ª∑ l·ªá s·ªü h·ªØu (%)</Label>
                                                    <div className="h-10 px-4 border rounded-md bg-blue-50 flex items-center font-bold text-blue-600">
                                                        {founder.ownershipPercentage.toFixed(2)}%
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    ))}

                                    <Button
                                        onClick={addFounder}
                                        variant="outline"
                                        className="w-full h-12 border-dashed border-2 hover:bg-blue-50"
                                    >
                                        <UserPlus className="mr-2 h-5 w-5" />
                                        Th√™m th√†nh vi√™n
                                    </Button>

                                    {founders.length > 0 && (
                                        <div className="p-4 bg-blue-50 rounded-lg border border-blue-200">
                                            <div className="flex justify-between items-center">
                                                <span className="font-bold">T·ªïng t·ª∑ l·ªá s·ªü h·ªØu:</span>
                                                <span className={cn(
                                                    "text-xl font-black",
                                                    Math.abs(founders.reduce((sum, f) => sum + f.ownershipPercentage, 0) - 100) < 0.01
                                                        ? "text-green-600"
                                                        : "text-red-600"
                                                )}>
                                                    {founders.reduce((sum, f) => sum + f.ownershipPercentage, 0).toFixed(2)}%
                                                </span>
                                            </div>
                                            {Math.abs(founders.reduce((sum, f) => sum + f.ownershipPercentage, 0) - 100) >= 0.01 && (
                                                <p className="text-sm text-red-600 mt-2">
                                                    T·ªïng t·ª∑ l·ªá ph·∫£i b·∫±ng 100%
                                                </p>
                                            )}
                                        </div>
                                    )}
                                </Card>

                                <div className="flex justify-center pt-4">
                                    <Button
                                        onClick={() => setCurrentStep(7)}
                                        disabled={!isFoundersValid()}
                                        className="h-14 px-16 bg-blue-600 text-lg font-bold rounded-xl shadow-xl hover:bg-blue-700"
                                    >
                                        Ti·∫øp t·ª•c <ArrowRight className="ml-2 h-5 w-5" />
                                    </Button>
                                </div>
                            </motion.div>
                        )}

                        {/* STEP 7: Package Selection */}
                        {currentStep === 8 && (
                            <motion.div key="step7" initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }} className="space-y-10 max-w-6xl mx-auto">
                                <div className="text-center space-y-4">
                                    <h2 className="text-3xl font-display font-bold text-brand-navy">Ch·ªçn g√≥i d·ªãch v·ª•</h2>
                                    <p className="text-muted-foreground">L·ª±a ch·ªçn g√≥i ph√π h·ª£p v·ªõi nhu c·∫ßu c·ªßa doanh nghi·ªáp</p>
                                </div>

                                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                    {PACKAGE_OPTIONS.map((pkg) => (
                                        <Card
                                            key={pkg.id}
                                            className={cn(
                                                "relative flex flex-col p-8 border-2 cursor-pointer transition-all hover:shadow-2xl",
                                                selectedPackageId === pkg.id ? "border-blue-500 ring-2 ring-blue-500 bg-blue-50/30" : "hover:border-blue-200"
                                            )}
                                            onClick={() => setSelectedPackageId(pkg.id)}
                                        >
                                            {pkg.isPopular && (
                                                <div className="absolute top-0 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-blue-600 text-white text-xs font-bold px-4 py-1 rounded-full uppercase">
                                                    Ph·ªï bi·∫øn
                                                </div>
                                            )}
                                            <h3 className="text-xl font-bold mb-2">{pkg.name}</h3>
                                            <p className="text-3xl font-black text-blue-600 mb-2">{formatCurrency(pkg.price)}</p>
                                            <p className="text-sm text-muted-foreground mb-6">{pkg.desc}</p>
                                            <ul className="space-y-3 mb-8 flex-grow">
                                                {pkg.features.map((f, i) => (
                                                    <li key={i} className="text-sm flex gap-2 font-medium">
                                                        <Check className="h-4 w-4 text-blue-500 shrink-0 mt-0.5" />
                                                        {f}
                                                    </li>
                                                ))}
                                            </ul>
                                            <Button
                                                variant={selectedPackageId === pkg.id ? "default" : "outline"}
                                                className={cn("w-full h-12 font-bold", selectedPackageId === pkg.id && "bg-blue-600")}
                                            >
                                                {selectedPackageId === pkg.id ? "ƒê√£ ch·ªçn" : "Ch·ªçn g√≥i n√†y"}
                                            </Button>
                                        </Card>
                                    ))}
                                </div>

                                <div className="flex justify-center pt-4">
                                    <Button
                                        onClick={() => setCurrentStep(8)}
                                        className="h-14 px-16 bg-blue-600 text-lg font-bold rounded-xl shadow-xl hover:bg-blue-700"
                                    >
                                        Xem t√≥m t·∫Øt & Thanh to√°n <ArrowRight className="ml-2 h-5 w-5" />
                                    </Button>
                                </div>
                            </motion.div>
                        )}

                        {/* STEP 8: Confirmation & Payment */}
                        {currentStep === 9 && (
                            <motion.div key="step8" initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }} className="space-y-10 max-w-4xl mx-auto">
                                <div className="text-center space-y-4">
                                    <h2 className="text-3xl font-display font-bold text-brand-navy">X√°c nh·∫≠n th√¥ng tin</h2>
                                    <p className="text-muted-foreground">Ki·ªÉm tra l·∫°i th√¥ng tin tr∆∞·ªõc khi thanh to√°n</p>
                                </div>

                                <Card className="overflow-hidden shadow-2xl border-none">
                                    <div className="bg-brand-navy p-8 text-white flex justify-between items-center">
                                        <div>
                                            <h3 className="text-2xl font-bold">PHI·∫æU ƒêƒÇNG K√ù</h3>
                                            <p className="text-blue-200 text-sm mt-1 uppercase tracking-widest">H·ªá th·ªëng CONTI 24/7</p>
                                        </div>
                                        <FileText className="h-12 w-12 opacity-50" />
                                    </div>

                                    <div className="p-8 space-y-6 bg-white">
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                            <div className="space-y-4">
                                                <div>
                                                    <p className="text-xs font-bold text-muted-foreground uppercase mb-1">Lo·∫°i h√¨nh</p>
                                                    <p className="font-bold">{BUSINESS_TYPES.find(t => t.id === businessType)?.name}</p>
                                                </div>
                                                <div>
                                                    <p className="text-xs font-bold text-muted-foreground uppercase mb-1">T√™n c√¥ng ty</p>
                                                    <p className="font-bold">{companyNameVi}</p>
                                                    <p className="text-sm text-muted-foreground italic">{companyNameEn}</p>
                                                </div>
                                                <div>
                                                    <p className="text-xs font-bold text-muted-foreground uppercase mb-1">ƒê·ªãa ch·ªâ tr·ª• s·ªü</p>
                                                    <p className="text-sm">{address}</p>
                                                </div>
                                                <div>
                                                    <p className="text-xs font-bold text-muted-foreground uppercase mb-1">Li√™n h·ªá</p>
                                                    <p className="text-sm">{phone3} ‚Ä¢ {email3}</p>
                                                </div>
                                            </div>

                                            <div className="space-y-4">
                                                <div>
                                                    <p className="text-xs font-bold text-muted-foreground uppercase mb-1">V·ªën ƒëi·ªÅu l·ªá</p>
                                                    <p className="text-2xl font-black text-blue-600">{charterCapital} VNƒê</p>
                                                </div>
                                                <div>
                                                    <p className="text-xs font-bold text-muted-foreground uppercase mb-1">S·ªë th√†nh vi√™n</p>
                                                    <p className="font-bold">{founders.length} th√†nh vi√™n</p>
                                                </div>
                                                <div>
                                                    <p className="text-xs font-bold text-muted-foreground uppercase mb-1">Ng∆∞·ªùi ƒë·∫°i di·ªán</p>
                                                    <p className="font-bold">{legalRepName}</p>
                                                    <p className="text-sm text-muted-foreground">{legalRepTitle}</p>
                                                </div>
                                                <div className="p-4 bg-slate-50 rounded-lg border">
                                                    <p className="text-xs font-bold text-muted-foreground uppercase mb-1">G√≥i d·ªãch v·ª•</p>
                                                    <p className="font-bold">{selectedPackage.name}</p>
                                                    <p className="text-2xl font-black text-blue-600 mt-1">{formatCurrency(selectedPackage.price)}</p>
                                                </div>
                                            </div>
                                        </div>

                                        <div className="border-t pt-6 flex items-start gap-3">
                                            <Checkbox
                                                id="terms"
                                                checked={isAgreed}
                                                onCheckedChange={(v) => setIsAgreed(!!v)}
                                                className="mt-1 data-[state=checked]:bg-blue-600"
                                            />
                                            <Label htmlFor="terms" className="text-sm leading-relaxed text-slate-600 font-medium cursor-pointer">
                                                T√¥i x√°c nh·∫≠n c√°c th√¥ng tin tr√™n l√† ch√≠nh x√°c v√† ƒë·ªìng √Ω v·ªõi c√°c{' '}
                                                <span className="text-blue-600 underline">ƒëi·ªÅu kho·∫£n d·ªãch v·ª•</span> c·ªßa CONTI.
                                            </Label>
                                        </div>

                                        <Button
                                            onClick={handleSubmitFinal}
                                            disabled={isSubmitting || !isAgreed}
                                            className="w-full h-16 bg-blue-600 hover:bg-blue-700 text-xl font-bold rounded-2xl shadow-xl"
                                        >
                                            {isSubmitting ? (
                                                <>
                                                    <Loader2 className="mr-2 h-6 w-6 animate-spin" />
                                                    ƒêang x·ª≠ l√Ω...
                                                </>
                                            ) : (
                                                <>
                                                    <CreditCard className="mr-2 h-6 w-6" />
                                                    Thanh to√°n & G·ª≠i h·ªì s∆°
                                                </>
                                            )}
                                        </Button>
                                    </div>
                                </Card>
                            </motion.div>
                        )}

                        {/* SUCCESS SCREEN */}
                        {currentStep === 'success' && (
                            <motion.div
                                key="success"
                                initial={{ scale: 0.9, opacity: 0 }}
                                animate={{ scale: 1, opacity: 1 }}
                                className="text-center py-16 space-y-10 max-w-2xl mx-auto"
                            >
                                <div className="w-24 h-24 bg-green-100 rounded-full flex items-center justify-center mx-auto text-green-600 shadow-xl">
                                    <Check className="h-12 w-12" />
                                </div>

                                <div className="space-y-4">
                                    <h1 className="text-4xl font-display font-bold text-brand-navy">G·ª≠i h·ªì s∆° th√†nh c√¥ng!</h1>
                                    <p className="text-xl text-muted-foreground leading-relaxed">
                                        Y√™u c·∫ßu c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c ti·∫øp nh·∫≠n. Chuy√™n vi√™n CONTI s·∫Ω li√™n h·ªá t∆∞ v·∫•n trong v√≤ng 30 ph√∫t l√†m vi·ªác.
                                    </p>
                                </div>

                                <div className="p-8 bg-blue-50 border border-blue-100 rounded-3xl inline-block">
                                    <p className="text-xs text-blue-600 font-bold uppercase tracking-widest mb-1">M√£ tham chi·∫øu h·ªì s∆°</p>
                                    <p className="text-4xl font-display font-black text-blue-900 tracking-tighter">{referenceNumber}</p>
                                </div>

                                <div className="pt-4 flex flex-col sm:flex-row gap-4 justify-center">
                                    <Button asChild size="lg" className="bg-blue-600 hover:bg-blue-700 px-12 h-14 font-bold rounded-xl shadow-lg">
                                        <Link to="/">Quay v·ªÅ Trang ch·ªß</Link>
                                    </Button>
                                    <Button asChild variant="outline" size="lg" className="px-12 h-14 font-bold rounded-xl hover:bg-blue-50 border-blue-200 text-blue-600">
                                        <Link to="/portal">Xem ti·∫øn ƒë·ªô</Link>
                                    </Button>
                                </div>
                            </motion.div>
                        )}

                    </AnimatePresence>
                </div>
            </main>
            <Footer />
            <Toaster richColors closeButton />
        </div>
    );
}
